const loaderUtils = require('loader-utils');

module.exports = function (source) {
  //TODO: replace implicit importance by webpack.providePlugin
  const { components } = loaderUtils.getOptions(this);
  const componentsList = JSON.parse(components);
  const componentsDeclarations = componentsList
    .map(({ id }) => id)
    .join();
  const componentsImports = componentsList
    .reduce((acc, { path, id }) => acc + `import ${id} from './${path}';\n`, '');

  return source.replace("'use strict'", `
  'use strict'; 
  ${componentsImports};
  window.__components = [${componentsDeclarations}];`);
};
